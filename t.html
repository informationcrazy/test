<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Prompt Studio Pro - Master Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    borderRadius: { 'xl-2': '1.25rem', 'xl-3': '1.5rem' }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        body { transition: background-color 0.3s, color 0.3s; -webkit-tap-highlight-color: transparent; }
        .glass-nav { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); }
        .dark .glass-nav { background: rgba(15, 23, 42, 0.85); }
        .spinner { border: 3px solid rgba(255,255,255,0.3); border-top-color: #fff; border-radius: 50%; width: 20px; height: 20px; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .log-entry { border-bottom: 1px solid rgba(148, 163, 184, 0.1); padding: 4px 0; font-family: 'JetBrains Mono', monospace; }
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .dark ::-webkit-scrollbar-thumb { background: #334155; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 dark:bg-slate-950 dark:text-slate-100 min-h-screen pb-24 selection:bg-indigo-100 dark:selection:bg-indigo-500/30">

    <!-- Navigation (导航栏) -->
    <nav class="sticky top-0 z-50 glass-nav border-b border-slate-200 dark:border-slate-800 px-4 py-4 flex flex-col gap-3">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-2">
                <div class="bg-indigo-600 p-2 rounded-xl text-white shadow-lg shadow-indigo-200 dark:shadow-none">
                    <i data-lucide="sparkles" class="w-5 h-5"></i>
                </div>
                <h1 class="font-extrabold text-lg tracking-tight">PromptStudio <span class="text-indigo-600">Pro</span></h1>
            </div>
            <div class="flex items-center gap-2">
                <button id="themeToggle" class="p-2 bg-slate-100 dark:bg-slate-800 rounded-xl text-slate-500 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors">
                    <i data-lucide="sun" id="sunIcon" class="w-4 h-4 hidden"></i>
                    <i data-lucide="moon" id="moonIcon" class="w-4 h-4"></i>
                </button>
                <button id="syncModels" class="bg-indigo-50 dark:bg-indigo-900/20 text-indigo-700 dark:text-indigo-400 px-3 py-2 rounded-xl text-[10px] font-bold border border-indigo-100 dark:border-indigo-800 flex items-center gap-1 active:scale-95 transition-all">
                    <i data-lucide="refresh-cw" class="w-3 h-3"></i> Sync (同步)
                </button>
            </div>
        </div>
        
        <div class="space-y-2">
            <div class="relative">
                <input type="password" id="apiKey" class="w-full bg-slate-100 dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-xl px-4 py-2.5 text-xs outline-none focus:ring-2 focus:ring-indigo-500/20 transition-all text-slate-600 dark:text-slate-300" placeholder="API Key (AIza...)">
                <i data-lucide="key" class="absolute right-3 top-2.5 w-4 h-4 text-slate-300 dark:text-slate-600"></i>
            </div>
            <div class="flex items-center gap-2">
                <span class="text-[9px] font-bold text-slate-400 uppercase tracking-widest pl-1">Model:</span>
                <select id="modelSelect" class="flex-1 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-xl px-3 py-2 text-[11px] font-bold outline-none text-slate-700 dark:text-slate-200 appearance-none cursor-pointer">
                    <option value="gemini-1.5-flash">Gemini 1.5 Flash</option>
                    <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
                    <option value="gemini-2.0-flash-exp">Gemini 2.0 Flash</option>
                </select>
            </div>
        </div>
    </nav>

    <main class="p-4 max-w-xl mx-auto space-y-6">
        
        <!-- Input Area (输入区) -->
        <section class="bg-white dark:bg-slate-900 rounded-[2.5rem] p-6 shadow-sm border border-slate-200 dark:border-slate-800 space-y-4">
            <div class="flex items-center justify-between text-slate-400 dark:text-slate-500 font-bold text-[10px] uppercase tracking-widest px-2">
                <span class="flex items-center gap-2"><i data-lucide="pen-tool" class="w-4 h-4"></i> Prompt Draft (草稿)</span>
                <button id="clearInput" class="hover:text-red-500 transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
            </div>
            <textarea id="promptInput" class="w-full h-48 p-5 bg-slate-50 dark:bg-slate-950 border-none rounded-3xl focus:ring-2 focus:ring-indigo-500/20 outline-none text-sm leading-relaxed text-slate-700 dark:text-slate-300 placeholder:text-slate-300 dark:placeholder:text-slate-700 transition-all resize-none" placeholder="Enter your prompt idea here... (在此输入您的提示词想法...)"></textarea>
            <button id="optimizeBtn" class="w-full py-4.5 bg-indigo-600 hover:bg-indigo-700 text-white rounded-3xl font-bold flex items-center justify-center gap-3 shadow-xl shadow-indigo-100 dark:shadow-none active:scale-[0.98] transition-all">
                <i data-lucide="wand-2" class="w-5 h-5"></i>
                Optimize Prompt (开始优化)
            </button>
        </section>

        <!-- Result Area (结果区) -->
        <section id="resultArea" class="hidden space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500">
            <!-- Score Card -->
            <div class="bg-white dark:bg-slate-900 p-6 rounded-[2.5rem] border border-slate-200 dark:border-slate-800 shadow-sm flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <div class="p-3 bg-emerald-50 dark:bg-emerald-900/20 text-emerald-600 dark:text-emerald-400 rounded-2xl shadow-inner">
                        <i data-lucide="shield-check" class="w-6 h-6"></i>
                    </div>
                    <div>
                        <div class="text-[10px] font-bold text-slate-400 uppercase">Coach Score (评分)</div>
                        <div id="scoreValue" class="text-3xl font-black text-slate-800 dark:text-slate-100">0%</div>
                    </div>
                </div>
                <div class="text-right max-w-[50%]">
                    <p id="analysisSummary" class="text-[11px] text-slate-500 dark:text-slate-400 italic leading-relaxed"></p>
                </div>
            </div>

            <!-- Optimized Prompt Box -->
            <div class="bg-slate-900 rounded-[2.5rem] p-7 shadow-2xl border border-slate-800 space-y-5">
                <div class="flex items-center justify-between px-2">
                    <span class="text-indigo-400 font-bold text-xs uppercase tracking-widest flex items-center gap-2">
                        <i data-lucide="check-circle" class="w-4 h-4"></i> Optimized Version (优化版)
                    </span>
                    <button id="copyBtn" class="p-2 bg-slate-800 hover:bg-slate-700 text-slate-400 rounded-xl border border-slate-700 transition-all">
                        <i data-lucide="copy" class="w-4 h-4"></i>
                    </button>
                </div>
                <div id="optimizedOutput" class="text-indigo-50 font-mono text-[13px] leading-relaxed whitespace-pre-wrap bg-slate-950/40 p-6 rounded-3xl border border-slate-800 max-h-80 overflow-y-auto selection:bg-indigo-500/30"></div>
                <button id="runTestBtn" class="w-full py-4 bg-emerald-600 hover:bg-emerald-700 text-white rounded-3xl font-bold flex items-center justify-center gap-2 active:scale-95 transition-all shadow-lg shadow-emerald-950/20">
                    <i data-lucide="play-circle" class="w-5 h-5"></i>
                    Run Live Test (实测预览)
                </button>
            </div>

            <!-- Execution Preview -->
            <div id="previewArea" class="hidden bg-white dark:bg-slate-900 rounded-[2.5rem] p-6 border border-slate-200 dark:border-slate-800 shadow-sm space-y-4">
                <div class="text-slate-400 font-bold text-[10px] uppercase tracking-widest flex items-center gap-2 px-2">
                    <i data-lucide="terminal" class="w-4 h-4"></i> Execution Output (执行输出)
                </div>
                <div id="previewOutput" class="text-sm text-slate-700 dark:text-slate-300 leading-relaxed whitespace-pre-wrap bg-slate-50 dark:bg-slate-950 p-6 rounded-3xl border border-slate-100 dark:border-slate-800 max-h-96 overflow-y-auto"></div>
            </div>
        </section>

        <!-- System Logs (系统日志) -->
        <section class="bg-slate-800 dark:bg-black rounded-3xl p-5 border border-slate-700 shadow-inner">
            <div class="flex justify-between items-center mb-3 border-b border-slate-700 pb-2 px-1">
                <span class="text-slate-400 font-bold text-[10px] uppercase tracking-widest flex items-center gap-2">
                    <i data-lucide="activity" class="w-3.5 h-3.5"></i> System Logs (日志)
                </span>
                <button id="clearLogs" class="text-slate-500 text-[10px] hover:text-white underline font-bold transition-colors">Clear</button>
            </div>
            <div id="logViewport" class="text-[10px] text-slate-400 max-h-40 overflow-y-auto space-y-1.5 font-mono">
                <div class="log-entry text-emerald-400 opacity-80">[System] Master Edition Ready. (大师版就绪。)</div>
            </div>
        </section>
    </main>

    <!-- Global Loader (全局加载) -->
    <div id="loadingOverlay" class="hidden fixed inset-0 z-[60] flex items-center justify-center bg-slate-900/40 backdrop-blur-sm transition-all">
        <div class="bg-white dark:bg-slate-900 p-8 rounded-[2.5rem] shadow-2xl flex flex-col items-center gap-4">
            <div class="spinner border-t-indigo-600"></div>
            <p class="text-[10px] font-bold text-slate-600 dark:text-slate-400 uppercase tracking-widest">AI is Processing (处理中)...</p>
        </div>
    </div>

    <script>
        lucide.createIcons();

        // 1. Theme Management (主题管理)
        const currentTheme = localStorage.getItem('theme') || 'light';
        if (currentTheme === 'dark') {
            document.documentElement.classList.add('dark');
            document.getElementById('sunIcon').classList.remove('hidden');
            document.getElementById('moonIcon').classList.add('hidden');
        }
        document.getElementById('themeToggle').onclick = () => {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            document.getElementById('sunIcon').classList.toggle('hidden');
            document.getElementById('moonIcon').classList.toggle('hidden');
        };

        // 2. Persistence (持久化)
        const savedApiKey = localStorage.getItem('gemini_api_key');
        if (savedApiKey) document.getElementById('apiKey').value = savedApiKey;
        document.getElementById('apiKey').oninput = (e) => localStorage.setItem('gemini_api_key', e.target.value.trim());

        const writeLog = (msg, status = 'info') => {
            const viewport = document.getElementById('logViewport');
            const colorMap = { error: 'text-red-400', success: 'text-emerald-400', info: 'text-slate-400', warn: 'text-amber-400' };
            const timestamp = new Date().toLocaleTimeString('zh-CN', { hour12: false });
            const entry = document.createElement('div');
            entry.className = `log-entry ${colorMap[status] || colorMap.info}`;
            entry.textContent = `[${timestamp}] ${msg}`;
            viewport.appendChild(entry);
            viewport.scrollTop = viewport.scrollHeight;
        };

        // 3. API Core with Exponential Backoff (带指数退避的 API 核心)
        async function invokeGemini(text, isAnalysis = false) {
            const key = document.getElementById('apiKey').value.trim();
            if (!key) { writeLog("Missing API Key. (缺失密钥。)", 'error'); return null; }

            const model = document.getElementById('modelSelect').value;
            const endpoint = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${key}`;
            
            const payload = { contents: [{ parts: [{ text: text }] }] };
            if (isAnalysis) {
                payload.system_instruction = { 
                    parts: [{ text: "You are the Anthropic Master Coach. Evaluate prompt based on 9 chapters. Return ONLY JSON: {\"score\": number, \"analysis\": \"brief Chinese string\", \"optimizedPrompt\": \"rewritten prompt\"}. No markdown blocks." }] 
                };
                payload.generation_config = { response_mime_type: "application/json" };
            }

            let attempt = 0;
            const maxAttempts = 5;

            while (attempt < maxAttempts) {
                try {
                    writeLog(`Requesting ${model}... (Attempt ${attempt + 1})`);
                    const response = await fetch(endpoint, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    const result = await response.json();
                    
                    if (!response.ok) throw new Error(result.error?.message || "Unknown Error");
                    writeLog("Response received. (收到响应。)", 'success');
                    return result;
                } catch (err) {
                    attempt++;
                    if (attempt === maxAttempts) {
                        writeLog(`Failed after ${maxAttempts} attempts: ${err.message}`, 'error');
                        alert("Critical Error: " + err.message);
                        return null;
                    }
                    const delay = Math.pow(2, attempt) * 500;
                    writeLog(`Retrying in ${delay}ms...`, 'warn');
                    await new Promise(res => setTimeout(res, delay));
                }
            }
        }

        // 4. Interaction Handlers (交互处理)
        document.getElementById('syncModels').onclick = async () => {
            const key = document.getElementById('apiKey').value.trim();
            if (!key) return;
            const btn = document.getElementById('syncModels');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="spinner w-3 h-3 border-indigo-600"></span> Syncing...';
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${key}`);
                const data = await res.json();
                const list = data.models.filter(m => m.supportedGenerationMethods.includes("generateContent")).map(m => m.name.split('/')[1]);
                const select = document.getElementById('modelSelect');
                select.innerHTML = '';
                list.forEach(m => {
                    const opt = document.createElement('option');
                    opt.value = m; opt.text = m;
                    if(m.includes('1.5-flash')) opt.selected = true;
                    select.appendChild(opt);
                });
                writeLog(`Synced ${list.length} models successfully.`, 'success');
                btn.innerHTML = 'Synced!';
                setTimeout(() => { btn.innerHTML = originalText; lucide.createIcons(); }, 2000);
            } catch (e) { writeLog("Sync failed. Check key.", 'error'); btn.innerHTML = 'Error'; }
        };

        document.getElementById('optimizeBtn').onclick = async () => {
            const input = document.getElementById('promptInput').value.trim();
            if (!input) return;
            document.getElementById('loadingOverlay').classList.remove('hidden');
            try {
                const data = await invokeGemini(input, true);
                if (data && data.candidates?.[0]?.content) {
                    let raw = data.candidates[0].content.parts[0].text;
                    raw = raw.replace(/```json/gi, '').replace(/```/gi, '').trim();
                    const parsed = JSON.parse(raw);
                    document.getElementById('scoreValue').innerText = parsed.score + "%";
                    document.getElementById('analysisSummary').innerText = parsed.analysis;
                    document.getElementById('optimizedOutput').innerText = parsed.optimizedPrompt;
                    document.getElementById('resultArea').classList.remove('hidden');
                    document.getElementById('resultArea').scrollIntoView({ behavior: 'smooth' });
                }
            } catch (e) { writeLog(`Parsing Error: ${e.message}`, 'error'); }
            finally { document.getElementById('loadingOverlay').classList.add('hidden'); }
        };

        document.getElementById('runTestBtn').onclick = async () => {
            const prompt = document.getElementById('optimizedOutput').innerText;
            document.getElementById('loadingOverlay').classList.remove('hidden');
            try {
                const data = await invokeGemini(prompt, false);
                if (data && data.candidates?.[0]?.content) {
                    document.getElementById('previewOutput').innerText = data.candidates[0].content.parts[0].text;
                    document.getElementById('previewArea').classList.remove('hidden');
                    document.getElementById('previewArea').scrollIntoView({ behavior: 'smooth' });
                }
            } finally { document.getElementById('loadingOverlay').classList.add('hidden'); }
        };

        document.getElementById('copyBtn').onclick = () => {
            const txt = document.getElementById('optimizedOutput').innerText;
            navigator.clipboard.writeText(txt).then(() => {
                writeLog("Prompt copied to clipboard. (已复制。)", 'success');
                alert("Copied! (已复制)");
            });
        };
        document.getElementById('clearInput').onclick = () => document.getElementById('promptInput').value = '';
        document.getElementById('clearLogs').onclick = () => document.getElementById('logViewport').innerHTML = '';
    </script>
</body>
</html>
